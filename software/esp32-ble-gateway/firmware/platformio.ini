; PlatformIO Project Configuration File
; ESP32-S3 BLE Gateway for CP02 Charging Station
; 
; This firmware connects to CP02 chargers via BLE and publishes data to MQTT
; Supports multiple ESP32 gateways for multiple chargers
;
; Enhanced Features:
; - WiFiManager for captive portal configuration
; - OTA (Over-The-Air) firmware updates
; - Persistent configuration storage

[platformio]
default_envs = esp32s3

[env:esp32s3]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

; Monitor configuration
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; Flash configuration for ESP32-S3
board_build.flash_mode = qio
board_build.f_flash = 80000000L
board_build.f_cpu = 240000000L

; Build flags
build_flags = 
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DCORE_DEBUG_LEVEL=3
    ; NimBLE configuration
    -DCONFIG_BT_NIMBLE_ROLE_CENTRAL=1
    -DCONFIG_BT_NIMBLE_ROLE_PERIPHERAL=0
    -DCONFIG_BT_NIMBLE_MAX_CONNECTIONS=3
    ; OTA enabled
    -DOTA_ENABLED=1

; Upload configuration
upload_speed = 921600

; OTA upload settings
upload_protocol = espota
upload_port = ESP32-BLE-Gateway.local
upload_flags =
    --port=3232

; Library dependencies
lib_deps = 
    ; BLE - NimBLE is more memory efficient than Bluedroid
    h2zero/NimBLE-Arduino@^1.4.1
    ; MQTT - Async for non-blocking operations
    marvinroger/AsyncMqttClient@^0.9.0
    ; JSON serialization
    bblanchon/ArduinoJson@^6.21.3
    ; WiFi Manager for easy configuration
    https://github.com/tzapu/WiFiManager.git#v2.0.16-rc.2
    ; Async TCP for ESP32
    https://github.com/me-no-dev/AsyncTCP.git

; Partition table for larger app with OTA
board_build.partitions = default_8MB.csv

[env:esp32s3_serial]
; Serial upload configuration (use this for first-time flashing)
extends = env:esp32s3
upload_protocol = esptool

[env:esp32s3_debug]
extends = env:esp32s3
upload_protocol = esptool
build_type = debug
build_flags = 
    ${env:esp32s3.build_flags}
    -DCORE_DEBUG_LEVEL=5
    -DDEBUG_ESP_PORT=Serial

[env:esp32_wroom]
; Alternative configuration for regular ESP32 (not S3)
platform = espressif32
board = esp32dev
framework = arduino

monitor_speed = 115200
monitor_filters = esp32_exception_decoder

build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -DCONFIG_BT_NIMBLE_ROLE_CENTRAL=1
    -DCONFIG_BT_NIMBLE_ROLE_PERIPHERAL=0
    -DCONFIG_BT_NIMBLE_MAX_CONNECTIONS=3
    -DOTA_ENABLED=1

lib_deps = 
    h2zero/NimBLE-Arduino@^1.4.1
    marvinroger/AsyncMqttClient@^0.9.0
    bblanchon/ArduinoJson@^6.21.3
    https://github.com/tzapu/WiFiManager.git#v2.0.16-rc.2
    https://github.com/me-no-dev/AsyncTCP.git

; Use min_spiffs partition for OTA support
board_build.partitions = min_spiffs.csv
