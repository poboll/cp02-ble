version: '3.8'

services:
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: cp02-mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    restart: unless-stopped
    networks:
      - cp02-network

  backend:
    build:
      context: ../backend
      dockerfile: ../docker/Dockerfile.backend
    container_name: cp02-backend
    ports:
      - "5225:5225"
    environment:
      - BLE_GW_MQTT_HOST=mosquitto
      - BLE_GW_MQTT_PORT=1883
      - BLE_GW_MQTT_TOPIC_PREFIX=cp02
      - BLE_GW_SERVER_HOST=0.0.0.0
      - BLE_GW_SERVER_PORT=5225
      - BLE_GW_GATEWAY_TIMEOUT_SECONDS=30
      - BLE_GW_API_KEY=
      - BLE_GW_OTA_UPLOAD_DIR=/app/ota_firmware
      - BLE_GW_MAX_FIRMWARE_SIZE=4194304
      - BLE_GW_FRONTEND_PATH=/app/frontend
    depends_on:
      - mosquitto
    restart: unless-stopped
    networks:
      - cp02-network
    volumes:
      - ../frontend:/app/frontend:ro
      - ota_firmware:/app/ota_firmware
      - history_data:/app/data

volumes:
  ota_firmware:
  history_data:

networks:
  cp02-network:
    driver: bridge
