# IonBridge BLE Controller - Web Interface Guide

## 概述

IonBridge BLE Controller 是一个功能完整的Web界面，用于通过蓝牙控制IonBridge（小电拼）设备。该系统支持所有78个BLE命令，提供现代化的用户界面和实时通信功能。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                     Web Browser                        │
│              (index.html + app.js)                  │
└────────────────────┬────────────────────────────────────┘
                     │ WebSocket
┌────────────────────▼────────────────────────────────────┐
│              FastAPI Backend (app.py)                │
│         - WebSocket endpoint: /ws                     │
│         - REST API endpoints                           │
│         - BLE Manager (ble_manager.py)               │
└────────────────────┬────────────────────────────────────┘
                     │ BLE
┌────────────────────▼────────────────────────────────────┐
│              IonBridge Device                         │
│              (CP02-XXXXXX)                         │
└────────────────────────────────────────────────────────────┘
```

## 快速开始

### 1. 安装依赖

```bash
pip3 install bleak fastapi uvicorn
```

### 2. 启动Web服务器

```bash
python3 ionbridge-ble-controller/app.py
```

服务器将在 `http://127.0.0.1:8000` 启动

### 3. 打开Web界面

在浏览器中访问: `http://127.0.0.1:8000`

## 功能模块

### 1. 设备管理

| 功能 | 说明 |
|------|------|
| 🔍 扫描设备 | 扫描附近的BLE设备 |
| 🔗 连接设备 | 连接到选定的IonBridge设备 |
| ❌ 断开连接 | 断开当前设备连接 |
| ℹ️ 设备信息 | 获取设备完整信息（型号、固件、序列号等） |
| ⚡ 电源状态 | 获取电源供应状态和打开的端口 |
| 🏷️ 设备型号 | 获取设备型号（pro/lite等） |
| 🔢 序列号 | 获取设备序列号 |
| ⏱️ 运行时间 | 获取设备运行时间 |
| 📱 固件版本 | 获取AP固件版本 |
| 📡 BLE地址 | 获取设备BLE地址 |
| 🔄 重启设备 | 重启IonBridge设备 |
| ⚠️ 重置设备 | 恢复出厂设置（危险操作） |

### 2. 端口控制

| 功能 | 说明 |
|------|------|
| 📊 端口状态 | 获取所有4个端口的状态、电压、电流、功率 |
| ⚡ 端口电源 | 打开/关闭指定端口（支持端口掩码） |
| ⚙️ 端口配置 | 查看和配置端口的充电协议 |
| 🎯 端口优先级 | 设置端口充电优先级（0-255） |
| 📋 协议管理 | 启用/禁用特定充电协议 |
| ⚡ 最大功率 | 设置设备最大功率限制 |
| 📈 查看最大功率 | 查看当前最大功率设置 |
| 🔌 端口最大功率 | 设置单个端口的最大功率限制 |
| 🌡️ 端口温度 | 获取端口温度 |

### 3. 电源管理

| 功能 | 说明 |
|------|------|
| 📈 电源统计 | 获取端口的电压、电流、功率、温度、运行时间 |
| 🎯 充电策略 | 查看当前充电策略（自动/固定/优先级） |
| ⚙️ 设置策略 | 设置充电策略 |
| 📊 充电状态 | 获取充电端口数量和状态 |

### 4. WiFi管理

| 功能 | 说明 |
|------|------|
| 📶 WiFi状态 | 查看WiFi连接状态和IP地址 |
| 🔍 扫描WiFi | 扫描可用的WiFi网络 |
| ⚙️ 设置WiFi | 配置WiFi SSID和密码 |

### 5. 显示管理

| 功能 | 说明 |
|------|------|
| 🖥️ 显示设置 | 查看亮度、模式、翻转设置 |
| 💡 设置亮度 | 调整显示亮度（0-100%） |
| 🎨 设置模式 | 选择显示模式（默认/简洁/详细/自定义） |
| 🔄 翻转显示 | 翻转显示方向 |

### 6. 系统控制

| 功能 | 说明 |
|------|------|
| 🔄 刷新Token | 手动刷新BLE Token |
| ⏰ 自动刷新 | 启用/禁用自动Token刷新（5分钟间隔） |
| 🔁 自动重连 | 启用/禁用自动重连（最多5次） |
| ℹ️ 系统信息 | 查看系统状态和配置 |

### 7. 高级设置

| 功能 | 说明 |
|------|------|
| 🌙 夜间模式 | 配置夜间模式时间和亮度 |
| 📊 查看夜间模式 | 查看当前夜间模式设置 |
| 🌐 语言设置 | 选择界面语言（中文/English/日本語/한국어） |
| 📊 查看语言 | 查看当前语言设置 |
| 💡 LED模式 | 配置LED显示模式（默认/呼吸灯/常亮/关闭） |
| 📊 查看LED模式 | 查看当前LED模式 |
| ⏰ 自动关闭 | 配置自动关闭超时时间 |
| 📊 查看自动关闭 | 查看当前自动关闭设置 |
| 🖼️ 屏保设置 | 配置屏保超时时间 |
| 📊 查看屏保 | 查看当前屏保设置 |

### 8. 版本信息

| 功能 | 说明 |
|------|------|
| 🔧 MCU版本 | 查看MCU固件版本 |
| ⚡ FPGA版本 | 查看FPGA固件版本 |
| 🔌 SW3566版本 | 查看SW3566芯片版本 |

## 支持的充电协议

系统支持24种充电协议：

| 协议 | 说明 |
|------|------|
| TFCP | Tesla Fast Charge Protocol |
| PE | Pump Express |
| QC2.0 | Quick Charge 2.0 |
| QC3.0 | Quick Charge 3.0 |
| QC3+ | Quick Charge 3+ |
| AFC | Adaptive Fast Charging |
| FCP | Fast Charge Protocol |
| HV_SCP | High Voltage SCP |
| LV_SCP | Low Voltage SCP |
| SFCP | Samsung Fast Charge Protocol |
| Apple 5V | Apple 5V Charging |
| Samsung 5V | Samsung 5V Charging |
| BC1.2 | Battery Charging 1.2 |
| UFCS | Unified Fast Charging Specification |
| RPi 5V5A | Raspberry Pi 5V5A |
| VOOC | VOOC Fast Charging |
| PD | USB Power Delivery |
| PPS | Programmable Power Supply |
| QC4.0 | Quick Charge 4.0 |
| QC4+ | Quick Charge 4+ |
| Dash/Warp | OnePlus Dash/Warp Charging |
| SFC | Super Fast Charge |
| MTK PE | MediaTek Pump Express |
| MTK PE+ | MediaTek Pump Express+ |

## 端口掩码使用

端口掩码用于同时控制多个端口：

| 掩码值 | 端口 |
|---------|------|
| 0x01 (1) | 端口1 |
| 0x02 (2) | 端口2 |
| 0x04 (4) | 端口3 |
| 0x08 (8) | 端口4 |
| 0x03 (3) | 端口1+2 |
| 0x05 (5) | 端口1+3 |
| 0x0F (15) | 所有端口 |

**使用示例**:
- 输入 `1` 控制端口1
- 输入 `1,2,3` 控制端口1、2、3
- 输入 `15` 或 `0x0F` 控制所有端口

## Token机制

### 自动刷新
- 系统每5分钟自动刷新Token
- 使用暴力破解方法（0x00-0xFF）
- 刷新过程在后台进行，不影响使用

### 手动刷新
- 点击"刷新Token"按钮手动刷新
- 刷新过程会显示在日志中

### Token显示
- Token以十六进制格式显示（例如：0xFE）
- Token值范围：0x00-0xFF（0-255）

## 状态栏

状态栏显示实时系统信息：

| 项目 | 说明 |
|------|------|
| 设备 | 当前连接的设备名称 |
| 连接状态 | 已连接/未连接 |
| Token | 当前Token值（十六进制） |
| 自动刷新 | 启用/禁用 |
| 自动重连 | 启用/禁用 |
| 运行时间 | 设备运行时间 |

## 日志系统

日志面板显示所有操作日志：

| 日志类型 | 颜色 | 说明 |
|---------|------|------|
| info | 绿色 | 常规信息 |
| error | 红色 | 错误信息 |
| warning | 橙色 | 警告信息 |

**日志格式**: `[时间戳] 消息内容`

## WebSocket通信

### 连接
- 自动连接到 `ws://127.0.0.1:8000/ws`
- 断开后自动重连（5秒间隔）

### 消息格式

**发送消息**:
```json
{
  "action": "get_device_info",
  "params": {}
}
```

**接收消息**:
```json
{
  "type": "response",
  "action": "get_device_info",
  "success": true,
  "data": {
    "model": "pro",
    "firmware": "6",
    "serial": "110"
  }
}
```

## API端点

### WebSocket端点
- `ws://127.0.0.1:8000/ws` - WebSocket实时通信

### HTTP端点
- `GET /` - 主页面
- `GET /static/*` - 静态资源

## 测试

### 运行测试脚本

```bash
python3 ionbridge-ble-controller/web_interface_test.py
```

### 测试结果

最新测试结果：**100%成功率**（33/33通过）

详细测试报告：[WEB_INTERFACE_TEST_REPORT.md](WEB_INTERFACE_TEST_REPORT.md)

## 故障排除

### 无法扫描设备
1. 确保蓝牙已启用
2. 检查设备是否在附近
3. 尝试增加扫描超时时间

### 连接失败
1. 确认设备地址正确
2. 检查设备是否被其他应用连接
3. 尝试重启设备

### Token刷新失败
1. 检查设备连接状态
2. 尝试手动刷新Token
3. 查看日志了解详细错误

### 端口控制无效
1. 检查设备是否在POWER_UP状态
2. 尝试重启设备
3. 确认端口掩码正确

### WebSocket连接失败
1. 确认Web服务器正在运行
2. 检查浏览器控制台错误
3. 尝试刷新页面

## 安全注意事项

1. ⚠️ **重置设备**操作会恢复出厂设置，不可恢复
2. ⚠️ **恢复出厂设置**会删除所有配置
3. 🔒 Token是设备认证的关键，请妥善保管
4. 📡 BLE连接可能被其他设备拦截，请注意安全

## 性能优化

1. **Token自动刷新**：启用后减少手动操作
2. **自动重连**：启用后提高连接稳定性
3. **批量操作**：使用端口掩码同时控制多个端口
4. **WebSocket**：使用WebSocket实现实时通信，减少延迟

## 未来功能

计划中的功能：
- [ ] WiFi配置向导
- [ ] 端口温度监控
- [ ] 历史数据查询
- [ ] OTA升级功能
- [ ] 多设备管理
- [ ] 导出配置
- [ ] 导入配置
- [ ] 定时任务
- [ ] 通知推送

## 技术栈

### 后端
- Python 3.13
- FastAPI 0.128.0
- Uvicorn 0.40.0
- Bleak 2.1.1

### 前端
- HTML5
- CSS3（响应式设计）
- JavaScript (ES6+)
- WebSocket API

### BLE协议
- 自定义BLE协议（9字节头部）
- Token认证机制
- 消息分片支持

## 贡献

欢迎贡献代码、报告问题或提出建议！

## 许可证

本项目基于IonBridge开源项目开发，遵循相应许可证。

## 联系方式

如有问题或建议，请通过以下方式联系：
- 提交Issue
- 发送Pull Request
- 参与讨论

---

**最后更新**: 2026-01-14  
**版本**: 1.0.0  
**状态**: ✅ 生产就绪
